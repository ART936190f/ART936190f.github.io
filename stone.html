<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Карта Стоунхенджа на Azure Maps — маршрути</title>

    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
    <script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js"></script>

    <style>
        /* Стилі для повноекранної карти */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #myMap {
            width: 100%;
            height: 60vh; /* Карта займатиме 60% висоти вікна */
        }

        #panoContainer {
            width: 100%;
            height: 40vh; /* Панорама займатиме 40% висоти вікна */
            border-top: 2px solid #ccc;
            box-sizing: border-box;
        }

        /* ПАНЕЛЬ ІНФОРМАЦІЇ ПРО МАРШРУТИ */
        #infoPanel {
            position: absolute;
            left: 10px;
            top: 70px;
            z-index: 2000;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            min-width: 220px;
            font-size: 14px;
        }

        /* ПАНЕЛЬ МУЗИКИ */
        #audioControl {
            position: absolute;
            right: 10px; /* Розміщуємо справа */
            top: 70px;
            z-index: 2000;
            background: rgba(255,255,255,0.95);
            padding: 5px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        #audioControl audio {
            width: 250px; /* Фіксована ширина для плеєра */
            height: 30px;
            margin: 0;
            padding: 0;
        }

        /* ЕЛЕМЕНТИ КЕРУВАННЯ (Кнопки) */
        #controls {
            position: absolute;
            left: 10px;
            top: 10px;
            z-index: 2000;
        }

        #controls button {
            margin-right: 6px;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        h2 { margin: 10px; }
    </style>
</head>

<body onload="InitMap()">
    <h1>Стоунхендж та околиці (Azure Maps)</h1>
    
    <div id="controls">
        <button id="toggleAmesbury">Приховати маршрут до Еймсбері</button>
        <button id="toggleLondon">Приховати маршрут до Лондона</button>
    </div>

    <div id="audioControl">
        <audio controls autoplay loop>
            <source src="music-for-relax.mp3" type="audio/mpeg">
            Ваш браузер не підтримує аудіо.
        </audio>
    </div>

    <div id="myMap"></div>

    <div id="infoPanel">
        <strong>Інформація про маршрути</strong>
        <div id="routesInfo">Завантаження...</div>
    </div>

    <div id="panoContainer">
        <h2>Панорамний перегляд (Google Street View)</h2>
        <iframe
            width="100%"
            height="100%"
            frameborder="0" style="border:0"
            src="https://www.google.com/maps/embed/v1/streetview?location=51.1789,-1.8262&heading=30&pitch=10&fov=90"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade">
        </iframe>
    </div>


    <script>
        // УВАГА: Замініть цей ключ на ваш дійсний ключ Azure Maps.
        const subscriptionKey = '3pk8sSL7JavoYHPg12dqZD9501gAE1p6bCH81oCILxLLRtBERj0BJQQJ99BJACYeBjFpcYJpAAAgAZMP1mBn';

        let map;
        let datasource;
        let routeDataSource;
        let popup;

        // Координати Стоунхенджа: [довгота, широта]
        const stonehengeCoords = [-1.8262, 51.1789];
        // Координати Еймсбері (найближче місто): [довгота, широта]
        const amesburyCoords = [-1.789, 51.176];
        // Координати Лондона: [довгота, широта]
        const londonCoords = [-0.1278, 51.5074];

        // Щоб ми могли вмикати/вимикати окремі маршрути
        const visibleRoutes = {
            toAmesbury: true,
            toLondon: true
        };
        
        // Зберігаємо результати маршрутів тут
        const routeResults = {};

        function InitMap() {
            // 1. Ініціалізація карти та зміна стилю
            map = new atlas.Map('myMap', {
                center: stonehengeCoords,
                zoom: 10, // Зменшено зум, щоб бачити обидва маршрути
                style: 'satellite_road_labels',
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: subscriptionKey
                }
            });

            map.events.add('ready', function () {
                // Створення джерел даних
                datasource = new atlas.source.DataSource();
                map.sources.add(datasource);

                routeDataSource = new atlas.source.DataSource();
                map.sources.add(routeDataSource);

                // Створення шару лінії для відображення маршруту
                const routeLayer = new atlas.layer.LineLayer(routeDataSource, null, {
                    strokeWidth: 5,
                    lineJoin: 'round',
                    lineCap: 'round',
                    strokeColor: ['match', ['get', 'routeId'],
                        'toAmesbury', 'darkgreen',
                        'toLondon', 'red',
                        'black'
                    ]
                });
                map.layers.add(routeLayer);

                // Єдине спливаюче вікно (яке ми будемо оновлювати)
                popup = new atlas.Popup({
                    content: '<div style="padding:10px;"><b>Стоунхендж</b><br>Стародавній пам\'ятник</div>',
                    position: stonehengeCoords,
                    pixelOffset: [0, -30]
                });


                // 2. Додавання міток (маркерів)
                addMarkers();

                // 3. Прокладання маршрутів
                const routeAmesburyPromise = calculateRoute(stonehengeCoords, amesburyCoords, 'toAmesbury', 'Еймсбері (Найближче місто)');
                const routeLondonPromise = calculateRoute(stonehengeCoords, londonCoords, 'toLondon', 'Лондон');

                // Чекаємо завершення обох
                Promise.allSettled([routeAmesburyPromise, routeLondonPromise])
                    .then(results => {
                        let finalPopupContent = '<div style="padding:10px;"><b>Стоунхендж</b><br>Стародавній пам\'ятник</div>';
                        let allRouteBounds = [];
                        
                        results.forEach(result => {
                            if (result.status === 'fulfilled' && result.value) {
                                // Додаємо дані маршруту на карту
                                routeDataSource.add(result.value.data);
                                
                                // Додаємо межі маршруту
                                const bounds = atlas.data.BoundingBox.fromData(result.value.data);
                                allRouteBounds.push(bounds);
                                
                                // Зберігаємо результат
                                routeResults[result.value.routeId] = {
                                    name: result.value.destinationName,
                                    travelTimeMinutes: result.value.travelTimeMinutes,
                                    lengthMeters: result.value.lengthMeters,
                                    geojson: result.value.data
                                };

                                // Формуємо контент для попапу
                                finalPopupContent += `
                                    <div style="padding: 5px 0; font-size: 14px; border-top: 1px dashed #ccc;">
                                        <b>Маршрут до ${result.value.destinationName}:</b>
                                        <br> 
                                        Приблизний час на машині: 
                                        <span style="font-weight: bold; color: ${result.value.routeId === 'toLondon' ? 'red' : 'darkgreen'};">
                                            ${result.value.travelTimeMinutes} хв.
                                        </span>
                                        ${result.value.lengthMeters ? '<br>Відстань: ' + (Math.round(result.value.lengthMeters/1000*10)/10) + ' км.' : ''}
                                    </div>
                                `;
                            } else {
                                const destinationName = result.reason && result.reason.destinationName ? result.reason.destinationName : 'Невідомий пункт';
                                finalPopupContent += `<div style="padding: 5px 0; font-size: 14px; color: red;">Помилка розрахунку до ${destinationName}.</div>`;
                            }
                        });

                        // Оновлюємо вміст попапу
                        popup.setContent(finalPopupContent);
                        popup.open(map); 
                        
                        // Оновлюємо панель інформації
                        updateInfoPanel();
                        // Встановлюємо видимість маршрутів
                        updateRoutesVisibility();

                        // Масштабування карти до всіх прокладених маршрутів
                        if (allRouteBounds.length > 0) {
                            const combinedBounds = atlas.data.BoundingBox.getCombined(allRouteBounds);
                            map.setCamera({ bounds: combinedBounds, padding: 50 });
                        }
                    });

                // 4. Додаткові елементи керування Azure Maps
                map.controls.add(new atlas.control.ZoomControl(), { position: 'top-right' });
                map.controls.add(new atlas.control.StyleControl({
                    mapStyles: ['road', 'grayscale_dark', 'satellite', 'satellite_road_labels', 'night']
                }), { position: 'top-right' });

                // Кнопки для приховування/показу маршруту
                document.getElementById('toggleAmesbury').addEventListener('click', function () {
                    visibleRoutes.toAmesbury = !visibleRoutes.toAmesbury;
                    updateRoutesVisibility();
                    this.textContent = (visibleRoutes.toAmesbury ? 'Приховати маршрут до Еймсбері' : 'Показати маршрут до Еймсбері');
                });
                document.getElementById('toggleLondon').addEventListener('click', function () {
                    visibleRoutes.toLondon = !visibleRoutes.toLondon;
                    updateRoutesVisibility();
                    this.textContent = (visibleRoutes.toLondon ? 'Приховати маршрут до Лондона' : 'Показати маршрут до Лондона');
                });
            });
        }

        function addMarkers() {
            // Мітка 1: Стоунхендж
            const markerStonehenge = new atlas.HtmlMarker({
                color: 'yellow',
                text: '🗿',
                position: stonehengeCoords,
                popup: popup // Використовуємо один об'єкт попапу
            });
            map.markers.add(markerStonehenge);
            
            map.events.add('click', markerStonehenge, () => { popup.toggle(); });

            // Мітка 2: Еймсбері
            const markerAmesbury = new atlas.HtmlMarker({
                color: 'darkgreen',
                text: 'A',
                position: amesburyCoords,
                popup: new atlas.Popup({ content: '<div style="padding:10px;"><b>Еймсбері</b></div>' })
            });
            map.markers.add(markerAmesbury);

            // Мітка 3: Лондон
            const markerLondon = new atlas.HtmlMarker({
                color: 'red',
                text: 'L',
                position: londonCoords,
                popup: new atlas.Popup({ content: '<div style="padding:10px;"><b>Лондон</b></div>' })
            });
            map.markers.add(markerLondon);
        }

        /**
         * Розраховує маршрут і повертає проміс з даними маршруту та часом.
         */
        function calculateRoute(startPoint, endPoint, routeId, destinationName) {
            return new Promise((resolve, reject) => {
                // Ключ передається тут
                const routeService = new atlas.service.RouteURL(new atlas.service.Aborter(), subscriptionKey);

                routeService.calculateRouteDirections(atlas.service.Aborter.timeout(10000), [startPoint, endPoint], {
                    travelMode: 'car'  // Режим поїздки
                })
                .then(response => {
                    const data = response.geojson.features || [];
                    const route = response.routes && response.routes[0];

                    if (!route) {
                        return reject({ message: 'Маршрут не знайдено', destinationName });
                    }
                    
                    const travelTimeSeconds = route.summary.travelTimeInSeconds;
                    const travelTimeMinutes = Math.round(travelTimeSeconds / 60);
                    const lengthMeters = route.summary.lengthInMeters;

                    // Додавання властивості routeId до GeoJSON для стилізації
                    data.forEach(feature => {
                        feature.properties = feature.properties || {};
                        feature.properties.routeId = routeId;
                    });
                    
                    resolve({
                        data,
                        travelTimeMinutes,
                        lengthMeters,
                        routeId,
                        destinationName
                    });
                })
                .catch(error => {
                    console.error(`Помилка при розрахунку маршруту до ${destinationName}:`, error);
                    reject({ message: error.message || 'API Error', destinationName });
                });
            });
        }

        function updateInfoPanel() {
            const infoDiv = document.getElementById('routesInfo');
            let html = '';

            if (Object.keys(routeResults).length === 0) {
                html = 'Маршрути ще завантажуються...';
            } else {
                Object.keys(routeResults).forEach(id => {
                    const r = routeResults[id];
                    if (!r) return;

                    const timeText = r.travelTimeMinutes !== '—' ? `${r.travelTimeMinutes} хв.` : '—';
                    const distText = r.lengthMeters ? `${Math.round(r.lengthMeters/1000*10)/10} км` : '—';
                    const color = id === 'toLondon' ? 'red' : 'darkgreen';

                    html += `<div style="margin-top:6px; padding-bottom:6px; border-bottom: 1px solid #eee;">
                                 <b style="color:${color}">${r.name}</b><br>
                                 Час: <strong>${timeText}</strong><br>
                                 Відстань: <strong>${distText}</strong>
                               </div>`;
                });
            }

            infoDiv.innerHTML = html;
        }

        // Схова/показ маршруту по routeId — фільтр у джерелі даних
        function updateRoutesVisibility() {
            routeDataSource.clear();
            
            // Проходимо по збережених результатах і додаємо тільки ті, що мають бути видимі
            const featuresToAdd = [];
            
            if (visibleRoutes.toAmesbury && routeResults.toAmesbury) {
                featuresToAdd.push(...routeResults.toAmesbury.geojson);
            }
            if (visibleRoutes.toLondon && routeResults.toLondon) {
                featuresToAdd.push(...routeResults.toLondon.geojson);
            }

            if (featuresToAdd.length > 0) {
                routeDataSource.add(featuresToAdd);
            }
        }

    </script>
</body>

</html>
