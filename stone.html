<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>–ö–∞—Ä—Ç–∞ –°—Ç–æ—É–Ω—Ö–µ–Ω–¥–∂–∞ –Ω–∞ Azure Maps ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏</title>

    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
    <script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js"></script>

    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–æ—ó –∫–∞—Ä—Ç–∏ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #myMap {
            width: 100%;
            height: 60vh; /* –ö–∞—Ä—Ç–∞ –∑–∞–π–º–∞—Ç–∏–º–µ 60% –≤–∏—Å–æ—Ç–∏ –≤—ñ–∫–Ω–∞ */
        }

        #panoContainer {
            width: 100%;
            height: 40vh; /* –ü–∞–Ω–æ—Ä–∞–º–∞ –∑–∞–π–º–∞—Ç–∏–º–µ 40% –≤–∏—Å–æ—Ç–∏ –≤—ñ–∫–Ω–∞ */
            border-top: 2px solid #ccc;
            box-sizing: border-box;
        }

        /* –ü–ê–ù–ï–õ–¨ –Ü–ù–§–û–†–ú–ê–¶–Ü–á –ü–†–û –ú–ê–†–®–†–£–¢–ò */
        #infoPanel {
            position: absolute;
            left: 10px;
            top: 70px;
            z-index: 2000;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            min-width: 220px;
            font-size: 14px;
        }

        /* –ü–ê–ù–ï–õ–¨ –ú–£–ó–ò–ö–ò */
        #audioControl {
            position: absolute;
            right: 10px; /* –†–æ–∑–º—ñ—â—É—î–º–æ —Å–ø—Ä–∞–≤–∞ */
            top: 70px;
            z-index: 2000;
            background: rgba(255,255,255,0.95);
            padding: 5px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        #audioControl audio {
            width: 250px; /* –§—ñ–∫—Å–æ–≤–∞–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –ø–ª–µ—î—Ä–∞ */
            height: 30px;
            margin: 0;
            padding: 0;
        }

        /* –ï–õ–ï–ú–ï–ù–¢–ò –ö–ï–†–£–í–ê–ù–ù–Ø (–ö–Ω–æ–ø–∫–∏) */
        #controls {
            position: absolute;
            left: 10px;
            top: 10px;
            z-index: 2000;
        }

        #controls button {
            margin-right: 6px;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        h2 { margin: 10px; }
    </style>
</head>

<body onload="InitMap()">
    <h1>–°—Ç–æ—É–Ω—Ö–µ–Ω–¥–∂ —Ç–∞ –æ–∫–æ–ª–∏—Ü—ñ (Azure Maps)</h1>
    
    <div id="controls">
        <button id="toggleAmesbury">–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ –ï–π–º—Å–±–µ—Ä—ñ</button>
        <button id="toggleLondon">–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ –õ–æ–Ω–¥–æ–Ω–∞</button>
    </div>

    <div id="audioControl">
        <audio controls autoplay loop>
            <source src="music-for-relax.mp3" type="audio/mpeg">
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∞—É–¥—ñ–æ.
        </audio>
    </div>

    <div id="myMap"></div>

    <div id="infoPanel">
        <strong>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç–∏</strong>
        <div id="routesInfo">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>

    <div id="panoContainer">
        <h2>–ü–∞–Ω–æ—Ä–∞–º–Ω–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ (Google Street View)</h2>
        <iframe
            width="100%"
            height="100%"
            frameborder="0" style="border:0"
            src="https://www.google.com/maps/embed/v1/streetview?location=51.1789,-1.8262&heading=30&pitch=10&fov=90"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade">
        </iframe>
    </div>


    <script>
        // –£–í–ê–ì–ê: –ó–∞–º—ñ–Ω—ñ—Ç—å —Ü–µ–π –∫–ª—é—á –Ω–∞ –≤–∞—à –¥—ñ–π—Å–Ω–∏–π –∫–ª—é—á Azure Maps.
        const subscriptionKey = '3pk8sSL7JavoYHPg12dqZD9501gAE1p6bCH81oCILxLLRtBERj0BJQQJ99BJACYeBjFpcYJpAAAgAZMP1mBn';

        let map;
        let datasource;
        let routeDataSource;
        let popup;

        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –°—Ç–æ—É–Ω—Ö–µ–Ω–¥–∂–∞: [–¥–æ–≤–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞]
        const stonehengeCoords = [-1.8262, 51.1789];
        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ï–π–º—Å–±–µ—Ä—ñ (–Ω–∞–π–±–ª–∏–∂—á–µ –º—ñ—Å—Ç–æ): [–¥–æ–≤–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞]
        const amesburyCoords = [-1.789, 51.176];
        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –õ–æ–Ω–¥–æ–Ω–∞: [–¥–æ–≤–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞]
        const londonCoords = [-0.1278, 51.5074];

        // –©–æ–± –º–∏ –º–æ–≥–ª–∏ –≤–º–∏–∫–∞—Ç–∏/–≤–∏–º–∏–∫–∞—Ç–∏ –æ–∫—Ä–µ–º—ñ –º–∞—Ä—à—Ä—É—Ç–∏
        const visibleRoutes = {
            toAmesbury: true,
            toLondon: true
        };
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç—ñ–≤ —Ç—É—Ç
        const routeResults = {};

        function InitMap() {
            // 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ —Ç–∞ –∑–º—ñ–Ω–∞ —Å—Ç–∏–ª—é
            map = new atlas.Map('myMap', {
                center: stonehengeCoords,
                zoom: 10, // –ó–º–µ–Ω—à–µ–Ω–æ –∑—É–º, —â–æ–± –±–∞—á–∏—Ç–∏ –æ–±–∏–¥–≤–∞ –º–∞—Ä—à—Ä—É—Ç–∏
                style: 'satellite_road_labels',
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: subscriptionKey
                }
            });

            map.events.add('ready', function () {
                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∂–µ—Ä–µ–ª –¥–∞–Ω–∏—Ö
                datasource = new atlas.source.DataSource();
                map.sources.add(datasource);

                routeDataSource = new atlas.source.DataSource();
                map.sources.add(routeDataSource);

                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —à–∞—Ä—É –ª—ñ–Ω—ñ—ó –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É
                const routeLayer = new atlas.layer.LineLayer(routeDataSource, null, {
                    strokeWidth: 5,
                    lineJoin: 'round',
                    lineCap: 'round',
                    strokeColor: ['match', ['get', 'routeId'],
                        'toAmesbury', 'darkgreen',
                        'toLondon', 'red',
                        'black'
                    ]
                });
                map.layers.add(routeLayer);

                // –Ñ–¥–∏–Ω–µ —Å–ø–ª–∏–≤–∞—é—á–µ –≤—ñ–∫–Ω–æ (—è–∫–µ –º–∏ –±—É–¥–µ–º–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏)
                popup = new atlas.Popup({
                    content: '<div style="padding:10px;"><b>–°—Ç–æ—É–Ω—Ö–µ–Ω–¥–∂</b><br>–°—Ç–∞—Ä–æ–¥–∞–≤–Ω—ñ–π –ø–∞–º\'—è—Ç–Ω–∏–∫</div>',
                    position: stonehengeCoords,
                    pixelOffset: [0, -30]
                });


                // 2. –î–æ–¥–∞–≤–∞–Ω–Ω—è –º—ñ—Ç–æ–∫ (–º–∞—Ä–∫–µ—Ä—ñ–≤)
                addMarkers();

                // 3. –ü—Ä–æ–∫–ª–∞–¥–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤
                const routeAmesburyPromise = calculateRoute(stonehengeCoords, amesburyCoords, 'toAmesbury', '–ï–π–º—Å–±–µ—Ä—ñ (–ù–∞–π–±–ª–∏–∂—á–µ –º—ñ—Å—Ç–æ)');
                const routeLondonPromise = calculateRoute(stonehengeCoords, londonCoords, 'toLondon', '–õ–æ–Ω–¥–æ–Ω');

                // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ–±–æ—Ö
                Promise.allSettled([routeAmesburyPromise, routeLondonPromise])
                    .then(results => {
                        let finalPopupContent = '<div style="padding:10px;"><b>–°—Ç–æ—É–Ω—Ö–µ–Ω–¥–∂</b><br>–°—Ç–∞—Ä–æ–¥–∞–≤–Ω—ñ–π –ø–∞–º\'—è—Ç–Ω–∏–∫</div>';
                        let allRouteBounds = [];
                        
                        results.forEach(result => {
                            if (result.status === 'fulfilled' && result.value) {
                                // –î–æ–¥–∞—î–º–æ –¥–∞–Ω—ñ –º–∞—Ä—à—Ä—É—Ç—É –Ω–∞ –∫–∞—Ä—Ç—É
                                routeDataSource.add(result.value.data);
                                
                                // –î–æ–¥–∞—î–º–æ –º–µ–∂—ñ –º–∞—Ä—à—Ä—É—Ç—É
                                const bounds = atlas.data.BoundingBox.fromData(result.value.data);
                                allRouteBounds.push(bounds);
                                
                                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                                routeResults[result.value.routeId] = {
                                    name: result.value.destinationName,
                                    travelTimeMinutes: result.value.travelTimeMinutes,
                                    lengthMeters: result.value.lengthMeters,
                                    geojson: result.value.data
                                };

                                // –§–æ—Ä–º—É—î–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–ø–∞–ø—É
                                finalPopupContent += `
                                    <div style="padding: 5px 0; font-size: 14px; border-top: 1px dashed #ccc;">
                                        <b>–ú–∞—Ä—à—Ä—É—Ç –¥–æ ${result.value.destinationName}:</b>
                                        <br> 
                                        –ü—Ä–∏–±–ª–∏–∑–Ω–∏–π —á–∞—Å –Ω–∞ –º–∞—à–∏–Ω—ñ: 
                                        <span style="font-weight: bold; color: ${result.value.routeId === 'toLondon' ? 'red' : 'darkgreen'};">
                                            ${result.value.travelTimeMinutes} —Ö–≤.
                                        </span>
                                        ${result.value.lengthMeters ? '<br>–í—ñ–¥—Å—Ç–∞–Ω—å: ' + (Math.round(result.value.lengthMeters/1000*10)/10) + ' –∫–º.' : ''}
                                    </div>
                                `;
                            } else {
                                const destinationName = result.reason && result.reason.destinationName ? result.reason.destinationName : '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—É–Ω–∫—Ç';
                                finalPopupContent += `<div style="padding: 5px 0; font-size: 14px; color: red;">–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –¥–æ ${destinationName}.</div>`;
                            }
                        });

                        // –û–Ω–æ–≤–ª—é—î–º–æ –≤–º—ñ—Å—Ç –ø–æ–ø–∞–ø—É
                        popup.setContent(finalPopupContent);
                        popup.open(map); 
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –ø–∞–Ω–µ–ª—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
                        updateInfoPanel();
                        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç—ñ–≤
                        updateRoutesVisibility();

                        // –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏ –¥–æ –≤—Å—ñ—Ö –ø—Ä–æ–∫–ª–∞–¥–µ–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
                        if (allRouteBounds.length > 0) {
                            const combinedBounds = atlas.data.BoundingBox.getCombined(allRouteBounds);
                            map.setCamera({ bounds: combinedBounds, padding: 50 });
                        }
                    });

                // 4. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è Azure Maps
                map.controls.add(new atlas.control.ZoomControl(), { position: 'top-right' });
                map.controls.add(new atlas.control.StyleControl({
                    mapStyles: ['road', 'grayscale_dark', 'satellite', 'satellite_road_labels', 'night']
                }), { position: 'top-right' });

                // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è/–ø–æ–∫–∞–∑—É –º–∞—Ä—à—Ä—É—Ç—É
                document.getElementById('toggleAmesbury').addEventListener('click', function () {
                    visibleRoutes.toAmesbury = !visibleRoutes.toAmesbury;
                    updateRoutesVisibility();
                    this.textContent = (visibleRoutes.toAmesbury ? '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ –ï–π–º—Å–±–µ—Ä—ñ' : '–ü–æ–∫–∞–∑–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ –ï–π–º—Å–±–µ—Ä—ñ');
                });
                document.getElementById('toggleLondon').addEventListener('click', function () {
                    visibleRoutes.toLondon = !visibleRoutes.toLondon;
                    updateRoutesVisibility();
                    this.textContent = (visibleRoutes.toLondon ? '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ –õ–æ–Ω–¥–æ–Ω–∞' : '–ü–æ–∫–∞–∑–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ –õ–æ–Ω–¥–æ–Ω–∞');
                });
            });
        }

        function addMarkers() {
            // –ú—ñ—Ç–∫–∞ 1: –°—Ç–æ—É–Ω—Ö–µ–Ω–¥–∂
            const markerStonehenge = new atlas.HtmlMarker({
                color: 'yellow',
                text: 'üóø',
                position: stonehengeCoords,
                popup: popup // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–¥–∏–Ω –æ–±'—î–∫—Ç –ø–æ–ø–∞–ø—É
            });
            map.markers.add(markerStonehenge);
            
            map.events.add('click', markerStonehenge, () => { popup.toggle(); });

            // –ú—ñ—Ç–∫–∞ 2: –ï–π–º—Å–±–µ—Ä—ñ
            const markerAmesbury = new atlas.HtmlMarker({
                color: 'darkgreen',
                text: 'A',
                position: amesburyCoords,
                popup: new atlas.Popup({ content: '<div style="padding:10px;"><b>–ï–π–º—Å–±–µ—Ä—ñ</b></div>' })
            });
            map.markers.add(markerAmesbury);

            // –ú—ñ—Ç–∫–∞ 3: –õ–æ–Ω–¥–æ–Ω
            const markerLondon = new atlas.HtmlMarker({
                color: 'red',
                text: 'L',
                position: londonCoords,
                popup: new atlas.Popup({ content: '<div style="padding:10px;"><b>–õ–æ–Ω–¥–æ–Ω</b></div>' })
            });
            map.markers.add(markerLondon);
        }

        /**
         * –†–æ–∑—Ä–∞—Ö–æ–≤—É—î –º–∞—Ä—à—Ä—É—Ç —ñ –ø–æ–≤–µ—Ä—Ç–∞—î –ø—Ä–æ–º—ñ—Å –∑ –¥–∞–Ω–∏–º–∏ –º–∞—Ä—à—Ä—É—Ç—É —Ç–∞ —á–∞—Å–æ–º.
         */
        function calculateRoute(startPoint, endPoint, routeId, destinationName) {
            return new Promise((resolve, reject) => {
                // –ö–ª—é—á –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è —Ç—É—Ç
                const routeService = new atlas.service.RouteURL(new atlas.service.Aborter(), subscriptionKey);

                routeService.calculateRouteDirections(atlas.service.Aborter.timeout(10000), [startPoint, endPoint], {
                    travelMode: 'car'  // –†–µ–∂–∏–º –ø–æ—ó–∑–¥–∫–∏
                })
                .then(response => {
                    const data = response.geojson.features || [];
                    const route = response.routes && response.routes[0];

                    if (!route) {
                        return reject({ message: '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', destinationName });
                    }
                    
                    const travelTimeSeconds = route.summary.travelTimeInSeconds;
                    const travelTimeMinutes = Math.round(travelTimeSeconds / 60);
                    const lengthMeters = route.summary.lengthInMeters;

                    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ routeId –¥–æ GeoJSON –¥–ª—è —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—ó
                    data.forEach(feature => {
                        feature.properties = feature.properties || {};
                        feature.properties.routeId = routeId;
                    });
                    
                    resolve({
                        data,
                        travelTimeMinutes,
                        lengthMeters,
                        routeId,
                        destinationName
                    });
                })
                .catch(error => {
                    console.error(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –º–∞—Ä—à—Ä—É—Ç—É –¥–æ ${destinationName}:`, error);
                    reject({ message: error.message || 'API Error', destinationName });
                });
            });
        }

        function updateInfoPanel() {
            const infoDiv = document.getElementById('routesInfo');
            let html = '';

            if (Object.keys(routeResults).length === 0) {
                html = '–ú–∞—Ä—à—Ä—É—Ç–∏ —â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è...';
            } else {
                Object.keys(routeResults).forEach(id => {
                    const r = routeResults[id];
                    if (!r) return;

                    const timeText = r.travelTimeMinutes !== '‚Äî' ? `${r.travelTimeMinutes} —Ö–≤.` : '‚Äî';
                    const distText = r.lengthMeters ? `${Math.round(r.lengthMeters/1000*10)/10} –∫–º` : '‚Äî';
                    const color = id === 'toLondon' ? 'red' : 'darkgreen';

                    html += `<div style="margin-top:6px; padding-bottom:6px; border-bottom: 1px solid #eee;">
                                 <b style="color:${color}">${r.name}</b><br>
                                 –ß–∞—Å: <strong>${timeText}</strong><br>
                                 –í—ñ–¥—Å—Ç–∞–Ω—å: <strong>${distText}</strong>
                               </div>`;
                });
            }

            infoDiv.innerHTML = html;
        }

        // –°—Ö–æ–≤–∞/–ø–æ–∫–∞–∑ –º–∞—Ä—à—Ä—É—Ç—É –ø–æ routeId ‚Äî —Ñ—ñ–ª—å—Ç—Ä —É –¥–∂–µ—Ä–µ–ª—ñ –¥–∞–Ω–∏—Ö
        function updateRoutesVisibility() {
            routeDataSource.clear();
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —ñ –¥–æ–¥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ, —â–æ –º–∞—é—Ç—å –±—É—Ç–∏ –≤–∏–¥–∏–º—ñ
            const featuresToAdd = [];
            
            if (visibleRoutes.toAmesbury && routeResults.toAmesbury) {
                featuresToAdd.push(...routeResults.toAmesbury.geojson);
            }
            if (visibleRoutes.toLondon && routeResults.toLondon) {
                featuresToAdd.push(...routeResults.toLondon.geojson);
            }

            if (featuresToAdd.length > 0) {
                routeDataSource.add(featuresToAdd);
            }
        }

    </script>
</body>

</html>
